<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>圖表理解與使用感受問卷（Google 試算表版｜FormData 送出）</title>
  <style>
    body { font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background:#fafafa; color:#333 }
    header { background:#f7b500; color:#fff; padding:16px 12px; text-align:center }
    main { max-width:900px; margin:24px auto; padding:0 16px }
    section { display:none; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.06) }
    section.active { display:block }
    h1,h2 { margin:0 0 12px }
    nav#breadcrumb { font-size:13px; opacity:.9 }
    label { display:block; margin:12px 0 }
    input, select, textarea, button { width:100%; font-size:16px; padding:10px 12px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box }
    textarea { min-height:96px }
    button { background:#f7b500; color:#fff; border:none; cursor:pointer }
    button[disabled] { opacity:.6; cursor:not-allowed }
    button:hover { background:#e09e00 }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .button-row { display:flex; gap:12px; justify-content:space-between }
    progress { width:100%; height:16px; margin:8px 0 12px }
    #chart-area img { max-width:100%; border-radius:10px; cursor:zoom-in; }
    #slider-wrap { display:none; text-align:center; gap:8px; align-items:center; margin-top:10px }
    #slider-value { min-width:48px; display:inline-block }
    table { width:100%; border-collapse:collapse; margin:10px 0 18px }
    th, td { border:1px solid #eaeaea; padding:8px; text-align:center }
    th { background:#fff3cd }
    .callout { background:#fffbe6; border:1px solid #ffe58f; padding:12px; border-radius:10px; font-size:14px }
    .muted { color:#777; font-size:13px }
    .success { color:#0a7a28 }
    dialog img { max-width:90vw; max-height:90vh }
  </style>
</head>
<body>
  <header>
    <h1>圖表理解與使用感受問卷</h1>
    <nav id="breadcrumb">資料 → 作答 → 問卷 → 送出</nav>
  </header>
  <main>
    <section id="conf-section" class="active">
      <h2>1) 目標與資料授權</h2>
      <p class="callout">此頁面會在本機紀錄你的作答，完成後由系統送到研究團隊的試算表。送出後不會收集個資，僅包含你輸入的 pid、年齡、性別與作答內容。</p>
      <div class="row">
        <label>（可留空自動產生）參與者編號 pid<input id="pid" placeholder="例如：P01" /></label>
        <label>年齡<input id="age" type="number" min="18" max="99" /></label>
      </div>
      <div class="row">
        <label>性別
          <select id="gender">
            <option value="">請選擇</option>
            <option value="M">男性</option>
            <option value="F">女性</option>
          </select>
        </label>
        <label class="muted">裝置資訊（自動偵測）<input id="device" disabled /></label>
      </div>
      <button id="start-btn">我了解並開始</button>
    </section>

    <section id="trial-section">
      <h2 id="trial-title">2) 題目 1 / 6</h2>
      <progress id="progress" value="1" max="6"></progress>
      <div id="chart-area"><img id="chart-image" alt="chart" /></div>
      <p id="question-text"></p>
      <input id="response" placeholder="請輸入答案" />
      <div id="slider-wrap"><input type="range" id="slider" min="80" max="160" value="120" /><span id="slider-value">120</span></div>
      <div class="button-row">
        <button id="prev-btn">上一題</button>
        <button id="next-btn">下一題</button>
      </div>
    </section>

    <section id="survey-section">
      <h2>3) 主觀問卷</h2>
      <div id="survey-forms"></div>
      <div class="row">
        <label>最偏好圖表類型
          <select id="preference">
            <option value="">請選擇</option>
            <option value="line">折線圖</option>
            <option value="bar">長條圖</option>
            <option value="heat">熱點圖</option>
          </select>
        </label>
        <label>其他意見<textarea id="open-feedback" placeholder="（選填）"></textarea></label>
      </div>
      <button id="finish-btn">完成</button>
    </section>

    <section id="done-section">
      <h2>4) 送出</h2>
      <p id="status" class="muted">尚未送出</p>
      <div class="row">
        <button id="send-sheets">送出作答</button>
        <button id="restart-btn" style="display:none; background:#666">重新作答</button>
      </div>
    </section>
  </main>

  <dialog id="img-dialog"><img id="dialog-img" /></dialog>

  <script>
    // ====== 管理者常數設定（不顯示給受試者）======
    const CONFIG = {
      WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbx9ikfl1kVFhTlmzCFzdDFiMWFA1piSsyxCed4hTDXp2f40Qcqmhh3CDUXUEb7cYs5j/exec', // ← 換成你的 /exec
      SECRET: 'mys3cret123', // ← 與 GAS SECRET_TOKEN 一致
    };

    // ==== 常數設定 ====
    const LATIN_ORDERS = ['L-B-P','L-P-B','B-L-P','B-P-L','P-L-B','P-B-L'];
    const TASKS = {
      'L': [
        { id:'A',  q:'哪一個月份案件數最多？', correct:'7月', type:'text' },
        { id:'A2', q:'請估計 2025/4 月案件數（±10 以內視為正確）', correct:120, type:'number' }
      ],
      'B': [
        { id:'C',  q:'哪個網站排名第 1？', correct:'siteA', type:'text' },
        { id:'C2', q:'哪個網站排名第 3？', correct:'siteC', type:'text' }
      ],
      'P': [
        { id:'B2', q:'哪一類／哪一群體佔比最高？', correct:'假投資', type:'text' },
        { id:'C2', q:'第二高的佔比為？（填百分比，不含 %）', correct:25, type:'number' }
      ]
    };
    const SURVEY_DIMENSIONS = ['易讀性','反應速度','信心程度','風險理解度'];

    // ==== 狀態 ====
    let participant = {};        // 單筆
    let trials = [];             // 6 題
    let surveys = [];            // 單筆
    let orderSeq = '';
    let tIndex = 0;              // 0..5
    let tStartAt = 0;            // 題目開始時間戳
    let hasSubmitted = false;    // ★ 防止重複上傳

    // ==== 工具 ====
    const $ = s => document.querySelector(s);
    const setActive = (hideSel, showSel) => { if (hideSel) $(hideSel).classList.remove('active'); if (showSel) $(showSel).classList.add('active'); };
    const deviceText = () => {
      const ua = navigator.userAgent;
      const plat = navigator.platform || '';
      if (ua.includes('Chrome')) return `Chrome on ${plat}`;
      if (ua.includes('Safari')) return `Safari on ${plat}`;
      if (ua.includes('Edg'))    return `Edge on ${plat}`;
      return plat || ua;
    };
    const genPid = () => {
      let n = +(localStorage.getItem('pidCount')||0)+1; localStorage.setItem('pidCount', n); return `P${String(n).padStart(2,'0')}`;
    };

    // ==== 初始 ====
    document.addEventListener('DOMContentLoaded', () => {
      $('#device').value = deviceText();
      $('#start-btn').onclick = startExp;
      $('#next-btn').onclick  = nextTrial;
      $('#prev-btn').onclick  = () => { if (tIndex>0) { tIndex--; showTrial(); } };
      $('#slider').oninput    = e => $('#slider-value').textContent = e.target.value;
      $('#chart-image').onclick = () => { $('#dialog-img').src = $('#chart-image').src; $('#img-dialog').showModal(); };
      $('#img-dialog').onclick   = () => $('#img-dialog').close();

      $('#finish-btn').onclick = finishSurvey;
      $('#send-sheets').onclick = sendToSheets;
      $('#restart-btn').onclick = () => { location.reload(); };
    });

    function startExp(){
      const pid = ($('#pid').value.trim() || genPid());
      const age = $('#age').value.trim();
      const gender = $('#gender').value;
      if (!age || !gender) { alert('請填寫年齡與性別'); return; }
      orderSeq = LATIN_ORDERS[Math.floor(Math.random()*LATIN_ORDERS.length)];
      participant = {
        pid, age, gender,
        order_seq: orderSeq,
        device: deviceText(),
        start_time: new Date().toISOString()
      };
      setActive('#conf-section', '#trial-section');
      startTrials();
    }

    function startTrials(){
      const seq = orderSeq.split('-');
      const all = [];
      seq.forEach(c => TASKS[c].forEach(t => all.push({ chart:c, ...t })));
      trials = all.slice(0,6); // 保證 6 題
      tIndex = 0;
      showTrial();
    }

    function showTrial(){
      const t = trials[tIndex];
      $('#trial-title').textContent = `2) 題目 ${tIndex+1} / ${trials.length}`;
      $('#progress').value = tIndex+1;
      $('#chart-image').src = t.chart==='L' ? 'assets/line_trend_1920x1080b.png' : (t.chart==='B' ? 'assets/bar_top10_1920x1080b.png' : 'assets/heat_month_1920x1080b.png');
      $('#question-text').textContent = t.q;
      $('#response').value = '';
      const sliderOn = (t.id==='A2');
      $('#slider-wrap').style.display = sliderOn ? 'grid' : 'none';
      $('#slider').value = 120; $('#slider-value').textContent = '120';
      tStartAt = Date.now();
    }

    function score(chart, id, input){
      const bank = TASKS[chart].find(x => x.id===id);
      const correct = bank.correct;
      let acc = 0;
      if (bank.type === 'number') {
        const val = parseFloat(input);
        if (id==='A2') acc = Math.abs(val - correct) <= 10 ? 1 : 0; else acc = (val === correct) ? 1 : 0;
      } else {
        const a = String(input).replace(/\s/g,'').toLowerCase();
        const b = String(correct).replace(/\s/g,'').toLowerCase();
        acc = (a===b) ? 1 : 0;
      }
      return { correct_answer: correct, accuracy: acc };
    }

    function nextTrial(){
      const t = trials[tIndex];
      const resp = (t.id==='A2') ? $('#slider').value : $('#response').value.trim();
      if (!resp) { alert('請輸入答案'); return; }
      const rt = Date.now() - tStartAt;
      const sc = score(t.chart, t.id, resp);
      Object.assign(t, { response: resp, ...sc, rt_ms: rt });
      if (tIndex < trials.length-1) { tIndex++; showTrial(); }
      else { setActive('#trial-section', '#survey-section'); buildSurvey(); }
    }

    function buildSurvey(){
      const host = $('#survey-forms'); host.innerHTML = '';
      ['line','bar','heat'].forEach(type => {
        let html = `<table><tr><th colspan="6">${type.toUpperCase()} 圖表評分</th></tr>`;
        html += '<tr><th>構面</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>';
        SURVEY_DIMENSIONS.forEach((d,i) => {
          html += `<tr><td>${d}</td>` + [1,2,3,4,5].map(v => `<td><input type="radio" name="${type}_${i+1}" value="${v}"></td>`).join('') + '</tr>';
        });
        html += '</table>';
        host.insertAdjacentHTML('beforeend', html);
      });
    }

    function finishSurvey(){
      const pref = $('#preference').value; if (!pref) { alert('請選擇偏好圖表類型'); return; }
      const s = { pid: participant.pid };
      for (const type of ['line','bar','heat']) {
        for (let i=1;i<=4;i++) {
          const el = document.querySelector(`input[name="${type}_${i}"]:checked`);
          if (!el) { alert('請完成所有評分'); return; }
          s[`s${i}_${type}`] = +el.value;
        }
      }
      s.preference = pref; s.open_feedback = $('#open-feedback').value.trim();
      surveys = [s];
      setActive('#survey-section', '#done-section');
      $('#status').textContent = '已完成作答，請按下方「送出作答」。';
    }

    // ==== 上傳至 Google 試算表（Apps Script Web App）====
    async function sendToSheets(){
      if (hasSubmitted) return;          // ★ 已送出就不再重送
      const btn = $('#send-sheets');
      btn.disabled = true;               // ★ 立刻禁用，避免連點
      btn.textContent = '傳送中…';

      const url = CONFIG.WEBAPP_URL.trim();
      const secret = CONFIG.SECRET.trim();
      if (!url) { alert('系統設定不完整：缺少 Web App URL'); btn.disabled=false; btn.textContent='送出作答'; return; }

      const payload = {
        secret,
        origin: window.location.origin,
        participants: [{ pid:participant.pid, age:+participant.age, gender:participant.gender, order_seq:participant.order_seq, device:participant.device, start_time:participant.start_time }],
        trials: trials.map((t,i)=>({ pid:participant.pid, trial_index:i+1, chart_type:t.chart, task_id:t.id, response:t.response, correct_answer:t.correct_answer, accuracy:t.accuracy, rt_ms:t.rt_ms })),
        surveys: surveys
      };

      try {
        $('#status').textContent = '傳送中…';
        const fd = new FormData();
        fd.append('payload', JSON.stringify(payload));
        const res = await fetch(url, { method:'POST', body: fd });
        const text = await res.text();
        let json = {};
        try { json = JSON.parse(text); } catch(_) { json = { ok: res.ok, raw: text }; }
        if ((json && json.ok) || res.ok) {
          const c = json.counts || {};
          hasSubmitted = true;                                 // ★ 標記已送出
          btn.textContent = '已送出（完成）';                  // ★ 改成完成
          $('#restart-btn').style.display = 'block';           // ★ 顯示重新作答
          $('#status').innerHTML = `已送出作答，感謝參與！<br>（系統紀錄：participants=${c.participants||0}, trials=${c.trials||0}, surveys=${c.surveys||0}）`;
        } else {
          btn.disabled = false;                                // 還原讓受試者可再試
          btn.textContent = '送出作答';
          $('#status').textContent = '送出失敗：' + (json && json.message || text || '未知錯誤');
        }
      } catch (e) {
        btn.disabled = false;                                  // 還原
        btn.textContent = '送出作答';
        console.error(e); $('#status').textContent = '送出失敗（可能是網路或權限）。錯誤：'+e.message;
      }
    }
  </script>
</body>
</html>
